<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - WebHost</title>
    <meta name="robots" content="noindex, nofollow">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Auth Guard: Redirects if not logged in -->
    <script>
        if (!localStorage.getItem('token')) {
            window.location.replace('/index.html');
        }
    </script>
    
    <header class="top-navbar">
        <a href="/" class="logo">WebHost</a>
        <div class="header-controls">
            <button id="logout-btn" class="btn btn-danger">Logout</button>
        </div>
    </header>

    <main class="page-container">
        <div class="flex-between">
            <h1 class="section-title">My <span>Projects</span></h1>
            <button id="new-project-btn" class="btn btn-primary">
                <i class="fas fa-plus"></i> New Project
            </button>
        </div>

        <div id="projects-list" class="projects-grid">
            <!-- Project cards will be injected here -->
            <div id="loading-state" class="text-center" style="grid-column: 1 / -1;">
                <span class="spinner large"></span>
                <p>Loading projects...</p>
            </div>
        </div>
    </main>
    
    <!-- MODALS -->
    <div id="modal-backdrop" class="hidden">
        <!-- New Project Modal -->
        <div id="new-project-modal" class="modal card hidden">
            <h2 class="modal-title">Create a New Project</h2>
            <form id="new-project-form">
                <label for="project-name">Project Name</label>
                <input type="text" id="project-name" class="form-input" placeholder="my-awesome-site" required>
                <p class="form-hint">This will be used to create your subdomain. e.g., my-awesome-site.webhost.app</p>
                <div class="modal-actions">
                    <button type="button" class="btn" data-close-modal>Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Project</button>
                </div>
            </form>
        </div>

        <!-- Deploy Modal -->
        <div id="deploy-modal" class="modal card hidden">
            <h2 class="modal-title">Deploy to "<span id="deploy-project-name"></span>"</h2>
            <form id="deploy-form">
                <input type="hidden" id="deploy-project-id">
                <div class="deploy-tabs">
                    <div class="deploy-tab active" data-tab="github"><i class="fab fa-github"></i> From GitHub</div>
                    <div class="deploy-tab" data-tab="upload"><i class="fas fa-file-zipper"></i> From .zip</div>
                </div>

                <!-- GitHub Deploy Form -->
                <div id="github-deploy-view" class="deploy-view active">
                    <label for="git-url">Public Git Repository URL</label>
                    <input type="url" id="git-url" class="form-input" placeholder="https://github.com/user/repo.git">
                    <p class="form-hint">Your repo must contain a pre-built static folder (e.g., `dist`, `build`, or `public`).</p>
                </div>
                <!-- Upload Deploy Form -->
                <div id="upload-deploy-view" class="deploy-view">
                    <label for="zip-file">Upload a .zip file of your site</label>
                    <input type="file" id="zip-file" class="form-input" accept=".zip">
                     <p class="form-hint">Zip the contents of your build folder (e.g., `dist`) and upload it here.</p>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn" data-close-modal>Cancel</button>
                    <button type="submit" class="btn btn-success">Start Deployment</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="toast-notification"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- CONFIGURATION ---
    const API_BASE_URL = ''; // Leave empty for production
    const token = localStorage.getItem('token');
    // IMPORTANT: Make sure this is your actual Render service domain!
    const DOMAIN_NAME = "o4d.onrender.com"; 

    // --- DOM ELEMENTS ---
    const projectsList = document.getElementById('projects-list');
    const loadingState = document.getElementById('loading-state');
    const newProjectBtn = document.getElementById('new-project-btn');
    const modalBackdrop = document.getElementById('modal-backdrop');
    const newProjectModal = document.getElementById('new-project-modal');
    const deployModal = document.getElementById('deploy-modal');
    const toast = document.getElementById('toast-notification');

    // --- API HELPERS ---
    const apiFetch = async (endpoint, options = {}) => {
        const res = await fetch(`${API_BASE_URL}/api${endpoint}`, {
            ...options,
            headers: { 'Authorization': `Bearer ${token}`, ...options.headers },
        });
        if (res.status === 401) { // Unauthorized
            localStorage.removeItem('token');
            window.location.replace('/index.html');
            throw new Error('Session expired. Please log in again.');
        }
        // Handle no-content responses for DELETE requests
        if (res.status === 204) {
            return;
        }
        const data = await res.json();
        if (!res.ok) throw new Error(data.message);
        return data;
    };

    // --- RENDER LOGIC ---
    const fetchAndRenderProjects = async () => {
        try {
            loadingState.style.display = 'block';
            projectsList.innerHTML = ''; // Clear previous
            const projects = await apiFetch('/projects');
            loadingState.style.display = 'none';

            if (projects.length === 0) {
                projectsList.innerHTML = `<p class="text-center" style="grid-column: 1 / -1;">You haven't created any projects yet. Click 'New Project' to get started!</p>`;
            } else {
                projects.forEach(project => {
                    const projectCard = document.createElement('div');
                    projectCard.className = 'card project-card';
                    projectCard.setAttribute('id', `project-card-${project._id}`);
                    projectCard.innerHTML = `
                        <h3>${project.name}</h3>
                        <a href="http://${project.subdomain}.${DOMAIN_NAME}" target="_blank" rel="noopener noreferrer" class="project-url">
                            ${project.subdomain}.${DOMAIN_NAME} <i class="fas fa-external-link-alt"></i>
                        </a>
                        <div class="project-status">
                            Status: <span class="status-badge ${project.status}">${project.status}</span>
                        </div>
                        <div class="project-actions">
                            <button class="btn btn-danger delete-btn" data-id="${project._id}" data-name="${project.name}">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                            <button class="btn btn-success deploy-btn" data-id="${project._id}" data-name="${project.name}">
                                <i class="fas fa-rocket"></i> Deploy
                            </button>
                        </div>
                    `;
                    projectsList.appendChild(projectCard);
                });
            }
        } catch (error) {
            showToast(error.message, 'error');
            loadingState.style.display = 'none';
        }
    };
    
    // --- MODAL HANDLING ---
    const showModal = (modal) => {
        modalBackdrop.classList.remove('hidden');
        modal.classList.remove('hidden');
    };
    const hideModals = () => {
        modalBackdrop.classList.add('hidden');
        document.querySelectorAll('.modal').forEach(m => m.classList.add('hidden'));
    };

    newProjectBtn.addEventListener('click', () => showModal(newProjectModal));
    modalBackdrop.addEventListener('click', (e) => {
        if (e.target === modalBackdrop || e.target.hasAttribute('data-close-modal')) {
            hideModals();
        }
    });

    // --- FORM SUBMISSIONS ---
    document.getElementById('new-project-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = e.target.querySelector('button[type="submit"]');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span>';
        
        try {
            const projectName = document.getElementById('project-name').value;
            await apiFetch('/projects', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: projectName }),
            });
            showToast('Project created successfully!', 'success');
            hideModals();
            fetchAndRenderProjects();
        } catch (error) {
            showToast(error.message, 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = 'Create Project';
        }
    });

    // --- DELEGATED EVENT LISTENER FOR DEPLOY & DELETE ---
    projectsList.addEventListener('click', async (e) => {
        const deployBtn = e.target.closest('.deploy-btn');
        const deleteBtn = e.target.closest('.delete-btn');

        // Handle Deploy
        if (deployBtn) {
            const projectId = deployBtn.dataset.id;
            const projectName = deployBtn.dataset.name;
            document.getElementById('deploy-project-name').textContent = projectName;
            document.getElementById('deploy-project-id').value = projectId;
            showModal(deployModal);
        }

        // Handle Delete
        if (deleteBtn) {
            const projectId = deleteBtn.dataset.id;
            const projectName = deleteBtn.dataset.name;

            if (confirm(`Are you sure you want to permanently delete the project "${projectName}"? This will also delete its deployed files and cannot be undone.`)) {
                try {
                    await apiFetch(`/projects/${projectId}`, { method: 'DELETE' });
                    showToast('Project deleted successfully.', 'success');
                    document.getElementById(`project-card-${projectId}`).remove();
                } catch (error) {
                    showToast(`Failed to delete project: ${error.message}`, 'error');
                }
            }
        }
    });

    // Switch deploy tabs (Git/Upload)
    document.querySelectorAll('.deploy-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('.deploy-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.deploy-view').forEach(v => v.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById(`${tab.dataset.tab}-deploy-view`).classList.add('active');
        });
    });

    // Handle deploy form submission
    document.getElementById('deploy-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = e.target.querySelector('button[type="submit"]');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> Deploying...';

        try {
            const formData = new FormData();
            formData.append('projectId', document.getElementById('deploy-project-id').value);

            const gitUrl = document.getElementById('git-url').value;
            const file = document.getElementById('zip-file').files[0];

            if (gitUrl) {
                formData.append('gitURL', gitUrl);
            } else if (file) {
                formData.append('file', file);
            } else {
                throw new Error('Please provide a Git URL or a .zip file.');
            }

            await fetch(`${API_BASE_URL}/api/deploy`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` },
                body: formData,
            });

            showToast('Deployment started! Your site will be live in a few moments.', 'success');
            hideModals();
            setTimeout(fetchAndRenderProjects, 3000); // Refresh list after a delay
        } catch (error) {
             showToast(error.message, 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = 'Start Deployment';
        }
    });
    
    // --- General ---
    document.getElementById('logout-btn').addEventListener('click', () => {
        localStorage.removeItem('token');
        window.location.replace('/index.html');
    });

    function showToast(message, type = 'success') {
        if (!toast) return;
        toast.textContent = message;
        toast.className = `toast-notification ${type} show`;
        setTimeout(() => { toast.classList.remove('show'); }, 4000);
    }
    
    // --- INITIALIZE ---
    fetchAndRenderProjects();
});
</script>
</body>
</html>
