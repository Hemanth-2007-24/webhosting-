<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - WebHost</title>
    <meta name="robots" content="noindex, nofollow">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <script>if (!localStorage.getItem('token')) { window.location.replace('/index.html'); }</script>
    <header class="top-navbar"><a href="/" class="logo">WebHost</a><div class="header-controls"><button id="logout-btn" class="btn btn-danger">Logout</button></div></header>
    <main class="page-container">
        <div class="flex-between"><h1 class="section-title">My <span>Projects</span></h1><button id="new-project-btn" class="btn btn-primary"><i class="fas fa-plus"></i> New Project</button></div>
        <div id="projects-list" class="projects-grid"><div id="loading-state" class="text-center" style="grid-column: 1 / -1;"><span class="spinner large"></span><p>Loading projects...</p></div></div>
    </main>
    <div id="modal-backdrop" class="hidden">
        <div id="new-project-modal" class="modal card hidden"><h2 class="modal-title">Create a New Project</h2><form id="new-project-form"><label for="project-name">Project Name</label><input type="text" id="project-name" class="form-input" placeholder="my-awesome-site" required><p class="form-hint">This will be used to create the URL path. e.g., /my-awesome-site-xyz</p><div class="modal-actions"><button type="button" class="btn" data-close-modal>Cancel</button><button type="submit" class="btn btn-primary">Create Project</button></div></form></div>
        <div id="deploy-modal" class="modal card hidden"><h2 class="modal-title">Deploy to "<span id="deploy-project-name"></span>"</h2><form id="deploy-form"><input type="hidden" id="deploy-project-id"><div class="deploy-tabs"><div class="deploy-tab active" data-tab="github"><i class="fab fa-github"></i> From GitHub</div><div class="deploy-tab" data-tab="upload"><i class="fas fa-file-zipper"></i> From .zip</div></div><div id="github-deploy-view" class="deploy-view active"><label for="git-url">Public Git Repository URL</label><input type="url" id="git-url" class="form-input" placeholder="https://github.com/user/repo.git"><p class="form-hint">Your repo must contain a pre-built static folder (e.g., `dist`, `build`, or `public`).</p></div><div id="upload-deploy-view" class="deploy-view"><label for="zip-file">Upload a .zip file of your site</label><input type="file" id="zip-file" class="form-input" accept=".zip"><p class="form-hint">Zip the contents of your build folder (e.g., `dist`) and upload it here.</p></div><div class="modal-actions"><button type="button" class="btn" data-close-modal>Cancel</button><button type="submit" class="btn btn-success">Start Deployment</button></div></form></div>
    </div>
    <div id="toast-notification"></div>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const API_BASE_URL = '';
    const token = localStorage.getItem('token');
    const DOMAIN_NAME = window.location.origin;
    const projectsList = document.getElementById('projects-list');
    const loadingState = document.getElementById('loading-state');
    const newProjectBtn = document.getElementById('new-project-btn');
    const modalBackdrop = document.getElementById('modal-backdrop');
    const toast = document.getElementById('toast-notification');
    const apiFetch = async (endpoint, options = {}) => { const res = await fetch(`${API_BASE_URL}/api${endpoint}`, { ...options, headers: { 'Authorization': `Bearer ${token}`, ...options.headers }, }); if (res.status === 401) { localStorage.removeItem('token'); window.location.replace('/index.html'); throw new Error('Session expired. Please log in again.'); } if (res.status === 204) { return; } const data = await res.json(); if (!res.ok) throw new Error(data.message); return data; };
    const fetchAndRenderProjects = async () => { try { loadingState.style.display = 'block'; projectsList.innerHTML = ''; const projects = await apiFetch('/projects'); loadingState.style.display = 'none'; if (projects.length === 0) { projectsList.innerHTML = `<p class="text-center" style="grid-column: 1 / -1;">You haven't created any projects yet. Click 'New Project' to get started!</p>`; } else { projects.forEach(project => { const projectCard = document.createElement('div'); projectCard.className = 'card project-card'; projectCard.setAttribute('id', `project-card-${project._id}`); projectCard.innerHTML = `<h3>${project.name}</h3><a href="/${project.subdomain}" target="_blank" rel="noopener noreferrer" class="project-url">${DOMAIN_NAME}/${project.subdomain} <i class="fas fa-external-link-alt"></i></a><div class="project-status">Status: <span class="status-badge ${project.status}">${project.status}</span></div><div class="project-actions"><button class="btn btn-danger delete-btn" data-id="${project._id}" data-name="${project.name}"><i class="fas fa-trash"></i> Delete</button><button class="btn btn-success deploy-btn" data-id="${project._id}" data-name="${project.name}"><i class="fas fa-rocket"></i> Deploy</button></div>`; projectsList.appendChild(projectCard); }); } } catch (error) { showToast(error.message, 'error'); loadingState.style.display = 'none'; } };
    const showModal = (modal) => { document.getElementById('modal-backdrop').classList.remove('hidden'); modal.classList.remove('hidden'); }; const hideModals = () => { document.getElementById('modal-backdrop').classList.add('hidden'); document.querySelectorAll('.modal').forEach(m => m.classList.add('hidden')); };
    document.getElementById('new-project-btn').addEventListener('click', () => showModal(document.getElementById('new-project-modal'))); document.getElementById('modal-backdrop').addEventListener('click', (e) => { if (e.target.id === 'modal-backdrop' || e.target.closest('[data-close-modal]')) { hideModals(); } });
    document.getElementById('new-project-form').addEventListener('submit', async (e) => { e.preventDefault(); const btn = e.target.querySelector('button[type="submit"]'); btn.disabled = true; btn.innerHTML = '<span class="spinner"></span>'; try { await apiFetch('/projects', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: document.getElementById('project-name').value }), }); showToast('Project created successfully!', 'success'); hideModals(); e.target.reset(); fetchAndRenderProjects(); } catch (error) { showToast(error.message, 'error'); } finally { btn.disabled = false; btn.innerHTML = 'Create Project'; } });
    projectsList.addEventListener('click', async (e) => { const deployBtn = e.target.closest('.deploy-btn'); const deleteBtn = e.target.closest('.delete-btn'); if (deployBtn) { document.getElementById('deploy-project-name').textContent = deployBtn.dataset.name; document.getElementById('deploy-project-id').value = deployBtn.dataset.id; showModal(document.getElementById('deploy-modal')); } if (deleteBtn) { if (confirm(`Are you sure you want to permanently delete the project "${deleteBtn.dataset.name}"?`)) { try { await apiFetch(`/projects/${deleteBtn.dataset.id}`, { method: 'DELETE' }); showToast('Project deleted.', 'success'); document.getElementById(`project-card-${deleteBtn.dataset.id}`).remove(); } catch (error) { showToast(`Error: ${error.message}`, 'error'); } } } });
    document.querySelectorAll('.deploy-tab').forEach(tab => { tab.addEventListener('click', () => { document.querySelectorAll('.deploy-tab').forEach(t => t.classList.remove('active')); document.querySelectorAll('.deploy-view').forEach(v => v.classList.remove('active')); tab.classList.add('active'); document.getElementById(`${tab.dataset.tab}-deploy-view`).classList.add('active'); }); });
    document.getElementById('deploy-form').addEventListener('submit', async (e) => { e.preventDefault(); const btn = e.target.querySelector('button[type="submit"]'); btn.disabled = true; btn.innerHTML = '<span class="spinner"></span> Deploying...'; try { const formData = new FormData(); formData.append('projectId', document.getElementById('deploy-project-id').value); const gitUrl = document.getElementById('git-url').value; const file = document.getElementById('zip-file').files[0]; if (gitUrl) { formData.append('gitURL', gitUrl); } else if (file) { formData.append('file', file); } else { throw new Error('Please provide a Git URL or a .zip file.'); } const res = await fetch(`${API_BASE_URL}/api/deploy`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` }, body: formData, }); if(!res.ok) { const errData = await res.json(); throw new Error(errData.message); } showToast('Deployment started!', 'success'); hideModals(); e.target.reset(); setTimeout(fetchAndRenderProjects, 3000); } catch (error) { showToast(error.message, 'error'); } finally { btn.disabled = false; btn.innerHTML = 'Start Deployment'; } });
    document.getElementById('logout-btn').addEventListener('click', () => { localStorage.removeItem('token'); window.location.replace('/index.html'); });
    function showToast(message, type = 'success') { if (!toast) return; toast.textContent = message; toast.className = `toast-notification ${type} show`; setTimeout(() => { toast.classList.remove('show'); }, 4000); }
    fetchAndRenderProjects();
});
</script>
</body>
</html>
